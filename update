#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$ROOT_DIR"

echo "==> Pull latest code"
git pull

echo "==> Install/update dependencies"
npm ci --include=optional

PLAYWRIGHT_BROWSERS_PATH_VALUE="${PLAYWRIGHT_BROWSERS_PATH:-0}"

if [[ "${SKIP_PLAYWRIGHT_INSTALL:-0}" != "1" ]]; then
  echo "==> Ensure Playwright Chromium is installed (PLAYWRIGHT_BROWSERS_PATH=${PLAYWRIGHT_BROWSERS_PATH_VALUE})"
  PLAYWRIGHT_BROWSERS_PATH="${PLAYWRIGHT_BROWSERS_PATH_VALUE}" npx playwright install chromium
fi

echo "==> Generate Prisma client (PostgreSQL)"
npm run prod:generate

echo "==> Apply database migrations (PostgreSQL)"
npm run prod:migrate

if [[ "${SKIP_BUILD:-0}" != "1" ]]; then
  echo "==> Build client + server"
  npm run build
fi

restart_server() {
  if [[ "${SKIP_RESTART:-0}" == "1" ]]; then
    echo "==> Skip restart (SKIP_RESTART=1)"
    return
  fi

  if [[ -n "${RESTART_CMD:-}" ]]; then
    echo "==> Restart server with RESTART_CMD"
    bash -lc "${RESTART_CMD}"
    return
  fi

  if [[ -n "${ALWAYSDATA_API_TOKEN:-}" && -n "${ALWAYSDATA_ACCOUNT:-}" && -n "${ALWAYSDATA_SITE_ID:-}" ]]; then
    if ! command -v curl >/dev/null 2>&1; then
      echo "curl is required for Alwaysdata API restart."
      exit 1
    fi

    echo "==> Restart Alwaysdata site ${ALWAYSDATA_SITE_ID}"
    curl --fail --silent --show-error \
      -X POST \
      --basic \
      --user "${ALWAYSDATA_API_TOKEN} account=${ALWAYSDATA_ACCOUNT}:" \
      "https://api.alwaysdata.com/v1/site/${ALWAYSDATA_SITE_ID}/restart/" >/dev/null
    return
  fi

  echo "==> No restart configured (set RESTART_CMD or ALWAYSDATA_API_TOKEN/ALWAYSDATA_ACCOUNT/ALWAYSDATA_SITE_ID)."
}

restart_server

echo "==> Update complete"
