#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$ROOT_DIR"

load_env_file() {
  local file="$1"
  if [[ -f "$file" ]]; then
    local label="${file#$ROOT_DIR/}"
    echo "==> Load env from ${label}"
    set -a
    # shellcheck disable=SC1090
    source "$file"
    set +a
  fi
}

# Allow restart settings to live in env files, with later files overriding earlier ones.
load_env_file "$ROOT_DIR/.env"
load_env_file "$ROOT_DIR/.env.production"
load_env_file "$ROOT_DIR/.env.update"

echo "==> Pull latest code"
git pull

NPM_INSTALL_MODE="${NPM_INSTALL_MODE:-ci}"

case "$NPM_INSTALL_MODE" in
  ci)
    echo "==> Install/update dependencies with npm ci"
    npm ci --include=optional
    ;;
  install)
    echo "==> Install/update dependencies with npm install (keeps existing node_modules)"
    npm install --include=optional
    ;;
  *)
    echo "Invalid NPM_INSTALL_MODE='${NPM_INSTALL_MODE}'. Expected 'ci' or 'install'."
    exit 1
    ;;
esac

resolve_playwright_browsers_path() {
  local value="$1"
  if [[ "$value" == "0" ]]; then
    echo "0"
    return
  fi
  if [[ "$value" == "~" ]]; then
    value="$HOME"
  elif [[ "$value" == "~/"* ]]; then
    value="$HOME/${value#~/}"
  fi
  if [[ "$value" != /* ]]; then
    value="$ROOT_DIR/$value"
  fi
  echo "$value"
}

PLAYWRIGHT_BROWSERS_PATH_VALUE_RAW="${PLAYWRIGHT_BROWSERS_PATH:-$ROOT_DIR/.cache/ms-playwright}"
PLAYWRIGHT_BROWSERS_PATH_VALUE="$(resolve_playwright_browsers_path "$PLAYWRIGHT_BROWSERS_PATH_VALUE_RAW")"
if [[ "$PLAYWRIGHT_BROWSERS_PATH_VALUE_RAW" != "$PLAYWRIGHT_BROWSERS_PATH_VALUE" ]]; then
  echo "==> Normalized PLAYWRIGHT_BROWSERS_PATH: ${PLAYWRIGHT_BROWSERS_PATH_VALUE_RAW} -> ${PLAYWRIGHT_BROWSERS_PATH_VALUE}"
fi

if [[ "${SKIP_PLAYWRIGHT_INSTALL:-0}" != "1" ]]; then
  echo "==> Ensure Playwright Chromium is installed (PLAYWRIGHT_BROWSERS_PATH=${PLAYWRIGHT_BROWSERS_PATH_VALUE})"
  if [[ "${PLAYWRIGHT_BROWSERS_PATH_VALUE}" != "0" ]]; then
    mkdir -p "${PLAYWRIGHT_BROWSERS_PATH_VALUE}"
  else
    echo "==> Warning: PLAYWRIGHT_BROWSERS_PATH=0 stores browsers inside node_modules."
    echo "==>          With npm ci, browsers are removed and must be reinstalled each deploy."
  fi
  # Use the server workspace binary to avoid npx fetching a mismatched Playwright version.
  PLAYWRIGHT_BROWSERS_PATH="${PLAYWRIGHT_BROWSERS_PATH_VALUE}" npm exec --workspace=server playwright install chromium
fi

echo "==> Generate Prisma client (PostgreSQL)"
npm run prod:generate

if [[ "${SKIP_TESTS:-0}" != "1" ]]; then
  echo "==> Run tests"
  npm run test
else
  echo "==> Skip tests (SKIP_TESTS=1)"
fi

echo "==> Apply database migrations (PostgreSQL)"
npm run prod:migrate

if [[ "${SKIP_BUILD:-0}" != "1" ]]; then
  echo "==> Build client + server"
  npm run build
fi

restart_server() {
  if [[ "${SKIP_RESTART:-0}" == "1" ]]; then
    echo "==> Skip restart (SKIP_RESTART=1)"
    return
  fi

  if [[ -n "${RESTART_CMD:-}" ]]; then
    echo "==> Restart server with RESTART_CMD"
    bash -lc "${RESTART_CMD}"
    return
  fi

  if [[ -n "${ALWAYSDATA_API_TOKEN:-}" && -n "${ALWAYSDATA_ACCOUNT:-}" && -n "${ALWAYSDATA_SITE_ID:-}" ]]; then
    if ! command -v curl >/dev/null 2>&1; then
      echo "curl is required for Alwaysdata API restart."
      exit 1
    fi

    echo "==> Restart Alwaysdata site ${ALWAYSDATA_SITE_ID}"
    curl --fail --silent --show-error \
      -X POST \
      --basic \
      --user "${ALWAYSDATA_API_TOKEN} account=${ALWAYSDATA_ACCOUNT}:" \
      "https://api.alwaysdata.com/v1/site/${ALWAYSDATA_SITE_ID}/restart/" >/dev/null
    return
  fi

  echo "==> No restart configured (set RESTART_CMD or ALWAYSDATA_API_TOKEN/ALWAYSDATA_ACCOUNT/ALWAYSDATA_SITE_ID in env or .env.update)."
}

restart_server

echo "==> Update complete"
